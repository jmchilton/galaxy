name: Performance Tests
on: [push, pull_request]
env:
  GALAXY_CONFIG_OVERRIDE_STATSD_PREFIX: galaxy
  GALAXY_CONFIG_OVERRIDE_STATSD_HOST: localhost
  GALAXY_CONFIG_OVERRIDE_STATSD_INFLUXDB: 'true'
  GALAXY_CONFIG_OVERRIDE_DATABASE_LOG_QUERY_COUNT: 'true'
  GALAXY_CONFIG_OVERRIDE_ENABLE_PER_REQUEST_SQL_DEBUGGING: 'true'
jobs:
  test:
    name: Test
    runs-on: ubuntu-18.04
    strategy:
      matrix:
        python-version: [3.7]
    services:
      metrics:
        image: samuelebistoletti/docker-statsd-influxdb-grafana:latest
        ports:
        - 3003:3003
        - 3004:8888
        - 8086:8086
        - 8125:8125
    steps:
    - uses: actions/checkout@v2
      with:
        path: 'galaxy root'
    - name: Clone galaxyproject/galaxy-test-data
      uses: actions/checkout@v2
      with:
        repository: galaxyproject/galaxy-test-data
        path: galaxy-test-data
    - uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python-version }}
    - name: Cache venv dir
      uses: actions/cache@v1
      id: pip-cache
      with:
        path: ~/.cache/pip
        key: pip-cache-${{ matrix.python-version }}-${{ hashFiles('galaxy root/requirements.txt') }}
    - name: Move test data
      run: rsync -av --remove-source-files --exclude .git galaxy-test-data/ 'galaxy root/test-data/'
    - name: Run tests
      run: './run_tests.sh -api "lib/galaxy_test/api/test_configuration.py"'
      working-directory: 'galaxy root'
    - name: Download stats
      run: "curl -H 'Accept: application/csv' -G 'http://localhost:8086/query' --data-urlencode 'db=telegraf' --data-urlencode 'q=select * from galaxy_' -o timings.csv"
    - name: Dump Stats
      run: cat timings.csv
