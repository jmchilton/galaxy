<macros>
	<!-- Import this at the top of your command block and then
	     defined use_rg and rg_auto_name. -->
    <token name="@define_read_group_helpers@">
#import re
#def identifier_or_name($input1)
#if hasattr($input1, 'element_identifier')
#return $input1.element_identifier
#else
#return $input1.name.rstrip('.gz').rstrip('.fastq').rstrip('.fq')
#end if
#end def
#def clean(name)
#set $name_clean = re.sub('[^\w\-_]', '_', $name)
#return $name_clean
#end def
	</token>
	<!-- preconditions use_rg and rg_auto_name have been
	     defined.
    -->
    <token name="@set_read_group_vars@">
#if $use_rg
#if $rg.read_group_id_conditional
#set $rg_id = $rg_auto_name
#else
#set $rg_id = str($rg.read_group_id_conditional.ID)
#end if
#if $rg.read_group_sm_conditional
#set $rg_sm = $rg_auto_name
#else
#set $rg_sm = str($rg.read_group_sm_conditional.SM)
#end if
#if $rg.PL
#set $rg_pl = str($rg.PL)
#else
#set $rg_pl = ''
#end if
#if $rg.read_group_lb_conditional
#set $rg_lb = $rg_auto_name
#else
#set $rg_lb = str($rg.read_group_lb_conditional.LB)
#end if
#if $rg.CN
#set $rg_cn = str($rg.CN)
#else
#set $rg_cn = ''
#end if
#if $rg.DS
#set $rg_ds = str($rg.DS)
#else
#set $rg_ds = ''
#end if
#if $rg.DT
#set $rg_dt = str($rg.DT)
#else
#set $rg_dt = ''
#end if
#if $rg.FO
#set $rg_fo = str($rg.FO)
#else
#set $rg_fo = ''
#end if
#if $rg.KS
#set $rg_ks = str($rg.KS)
#else
#set $rg_ks = ''
#end if
#if $rg.PG
#set $rg_pg = str($rg.PG)
#else
#set $rg_pg = ''
#end if
#if str($rg.PI)
#set $rg_pe = str($rg.PI)
#else
#set $rg_pe = ''
#end if
#if $rg.PU
#set $rg_pu = str($rg.PU)
#else
#set $rg_pu = ''
#end if
#end if
    </token>
    <xml name="read_group_auto_name_conditional">
        <param name="do_auto_name" type="boolean" label="Auto-assign" help="Use dataset name or collection information to automatically assign this value" checked="false" />
        <when value="true">
        </when>
        <when value="false">
            <yield />
        </when>
    </xml>
    <xml name="read_group_id_param">
        <param name="ID" type="text" value="" size="20" label="Read group identifier (ID)" help="This value must be unique among multiple samples in your experiment">
        <validator type="empty_field" />
        </param>
    </xml>
    <xml name="read_group_id_conditional">
        <conditonal name="read_group_id_conditional">
            <expand macro="read_group_auto_name_conditional">
            	<expand macro="read_group_id_param" />
            </expand>
        </conditonal>
    </xml>
    <xml name="read_group_sm_param">
        <param name="SM" type="text" value="" size="20" label="Read group sample name (SM)" help="This value should be descriptive. Use pool name where a pool is being sequenced" />
    </xml>
    <xml name="read_group_sm_conditional">
        <conditonal name="read_group_sm_conditional">
            <expand macro="read_group_auto_name_conditional">
            	<expand macro="read_group_sm_param" />
            </expand>
        </conditonal>
    </xml>
    <xml name="read_group_pl_param">
        <param name="PL" type="select" label="Platform/technology used to produce the reads (PL)">
            <option value="CAPILLARY">CAPILLARY</option>
            <option value="LS454">LS454</option>
            <option selected="True" value="ILLUMINA">ILLUMINA</option>
            <option value="SOLID">SOLID</option>
            <option value="HELICOS">HELICOS</option>
            <option value="IONTORRENT">IONTORRENT</option>
            <option value="PACBIO">PACBIO</option>
        </param>
    </xml>
    <xml name="read_group_lb_param">
        <param name="LB" type="text" size="25" label="Library name (LB)" />
    </xml>
    <xml name="read_group_lb_conditional">
        <conditonal name="read_group_lb_conditional">
            <expand macro="read_group_auto_name_conditional">
            	<expand macro="read_group_lb_param" />
            </expand>
        </conditonal>
    </xml>
    <xml name="read_group_cn_param">
        <param name="CN" type="text" size="25" label="Sequencing center that produced the read (CN)" />
    </xml>
    <xml name="read_group_ds_param">
        <param name="DS" type="text" size="25" label="Description (DS)" />
    </xml>
    <xml name="read_group_dt_param">
        <param name="DT" type="text" size="25" label="Date that run was produced (DT)" help="ISO8601 format date or date/time, like YYYY-MM-DD" />
    </xml>
    <xml name="read_group_fo_param">
        <param name="FO" type="text" size="25" optional="true" label="Flow order (FO)" help="The array of nucleotide bases that correspond to the nucleotides used for each flow of each read. Multi-base flows are encoded in IUPAC format, and non-nucleotide flows by various other characters. Format: /\*|[ACMGRSVTWYHKDBN]+/">
          <validator type="regex" message="Invalid flow order">\*|[ACMGRSVTWYHKDBN]+$</validator>
        </param>
    </xml>
    <xml name="read_group_ks_param">
        <param name="KS" type="text" size="25" label="The array of nucleotide bases that correspond to the key sequence of each read (KS)" />
    </xml>
    <xml name="read_group_pg_param">
        <param name="PG" type="text" size="25" label="Programs used for processing the read group (PG)" />
    </xml>
   	<xml name="read_group_pi_param">
        <param name="PI" type="integer" optional="true" label="Predicted median insert size (PI)" />
    </xml>
    <xml name="read_group_pu_param">
        <param name="PU" type="text" size="25" label="Platform unit (PU)" help="Unique identifier (e.g. flowcell-barcode.lane for Illumina or slide for SOLiD)" />
    </xml>
    <xml name="read_group_when_true">
        <expand macro="read_group_id_conditional" />
        <expand macro="read_group_sm_conditional" />
        <expand macro="read_group_pl_param" />
        <expand macro="read_group_lb_conditional" />
        <expand macro="read_group_cn_param" />
        <expand macro="read_group_ds_param" />
        <expand macro="read_group_dt_param" />
        <expand macro="read_group_fo_param" />
        <expand macro="read_group_ks_param" />
        <expand macro="read_group_pg_param" />
        <expand macro="read_group_pi_param" />
        <expand macro="read_group_pu_param" />
    </xml>
    <xml name="read_group_conditional">
        <conditional name="rg">
            <param name="rg_selector" type="select" label="Set read groups information?" help="(-R in bwa mem; -r in bwa aln); Specifying read group information can greatly simplify your downstream analyses by allowing combining multiple datasets. See help below for more details">
                <option value="set">Set</option>
                <option value="do_not_set" selected="True">Do not set</option>
            </param>
            <when value="set">
                <expand macro="read_group_when_true" />
            </when>
            <when value="do_not_set">
            </when>
        </conditional>
    </xml>
</macros>
